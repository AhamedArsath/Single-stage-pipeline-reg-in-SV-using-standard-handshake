module pipe_stage #(
    parameter data_width = 32
)
  (
    input  wire clk,
    input  wire rst_n,
    input  wire in_valid,
    output wire in_ready,
    input  wire [data_width-1:0] in_data,
    output wire out_valid,
    input  wire out_ready,
    output wire [data_width-1:0] out_data
);

    reg [data_width-1:0] data_reg;
    reg valid_reg;

    assign in_ready  = (~valid_reg) | out_ready;
    assign out_valid = valid_reg;
    assign out_data  = data_reg;

    always @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            valid_reg <= 1'b0;
            data_reg  <= {data_width{1'b0}};
        end
        else begin
            if (in_valid && in_ready) begin
                data_reg  <= in_data;
                valid_reg <= 1'b1;
            end
            else if (out_ready && valid_reg) begin
                valid_reg <= 1'b0;
            end
        end
    end

endmodule

